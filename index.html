
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSZFORD | Security Systems</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a; 
      }
      ::-webkit-scrollbar-thumb {
        background: #334155; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569; 
      }
      
      /* Animations */
      @keyframes radar-spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .radar-sweep {
        animation: radar-spin 4s linear infinite;
      }
      
      /* Utility for hiding/showing */
      .hidden {
        display: none !important;
      }
    </style>

    <!-- Import Map for Google GenAI -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.40.0"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-900 antialiased overflow-hidden h-screen w-screen">

    <!-- App Container -->
    <div id="app" class="h-full w-full"></div>

    <!-- Main Logic -->
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- STATE & DATA ---
        const state = {
            isAuthenticated: false,
            currentUser: null,
            currentView: 'dashboard',
            isSidebarOpen: true,
            incidents: [
                {
                    id: 'INC-2024-001',
                    title: 'Acceso No Autorizado Puerta Norte',
                    description: 'Individuo intentó ingresar sin credencial válida. Seguridad interceptó.',
                    location: 'Puerta Norte',
                    severity: 'Media',
                    status: 'Resuelto',
                    timestamp: '08:30 AM',
                    reportedBy: 'Guardia J. Perez',
                    coordinates: { x: 25, y: 48 }
                },
                {
                    id: 'INC-2024-002',
                    title: 'Fallo de Cámara C-14',
                    description: 'Pérdida de señal intermitente en sector de carga.',
                    location: 'Sector Carga',
                    severity: 'Baja',
                    status: 'Abierto',
                    timestamp: '09:15 AM',
                    reportedBy: 'Sistema Auto',
                    coordinates: { x: 60, y: 70 }
                },
                {
                    id: 'INC-2024-003',
                    title: 'Vehículo Sospechoso',
                    description: 'Vehículo sedán negro estacionado en zona prohibida por más de 45 mins.',
                    location: 'Perímetro Sur',
                    severity: 'Alta',
                    status: 'En Progreso',
                    timestamp: '10:45 AM',
                    reportedBy: 'Cámaras AI',
                    coordinates: { x: 50, y: 80 }
                }
            ],
            guards: [
                {
                    id: 'G-104',
                    name: 'Carlos Mendoza',
                    cedula: '1.140.852.369',
                    phone: '300 123 4567',
                    role: 'Vigilante',
                    status: 'Active',
                    location: 'Puesto Principal - Zona Sur',
                    batteryLevel: 85,
                    coordinates: { x: 48, y: 78 },
                    lastCheckIn: '10:00 AM',
                    image: null
                },
                {
                    id: 'G-108',
                    name: 'Ana Silva',
                    cedula: '1.098.765.432',
                    phone: '310 987 6543',
                    role: 'Vigilante',
                    status: 'Active',
                    location: 'Parqueadero B - Zona Sur',
                    batteryLevel: 62,
                    coordinates: { x: 15, y: 30 },
                    lastCheckIn: '10:15 AM',
                    image: null
                },
                {
                    id: 'G-120',
                    name: 'Mario Ruiz',
                    cedula: '79.543.210',
                    phone: '301 222 3344',
                    role: 'Portero',
                    status: 'Off Duty',
                    location: 'Recepción Torre A',
                    batteryLevel: 0,
                    coordinates: { x: 0, y: 0 },
                    lastCheckIn: '06:00 AM',
                    image: null
                }
            ],
            equipment: [
              { id: 'EQ-001', name: 'Armamento Letal (Portería)', type: 'weapon', model: 'Revolver Llama Scorpion .38', serial: 'R-982231', status: 'Operativo', lastInspection: '08:00 AM' },
              { id: 'EQ-002', name: 'Radio Principal', type: 'comms', model: 'Motorola DTR720', serial: 'M-554422', status: 'Operativo', batteryLevel: 85, lastInspection: '08:00 AM' },
              { id: 'EQ-003', name: 'Radio Secundario', type: 'comms', model: 'Motorola T400', serial: 'M-112233', status: 'En Mantenimiento', batteryLevel: 0, lastInspection: '07:30 AM', notes: 'Antena dañada' },
              { id: 'EQ-004', name: 'Linterna Táctica', type: 'light', model: 'Maglite LED Pro', serial: 'L-998877', status: 'Operativo', batteryLevel: 92, lastInspection: '08:00 AM' },
              { id: 'EQ-005', name: 'Capa Impermeable', type: 'protection', model: 'Industrial PVC Cal. 50', serial: 'I-001', status: 'Operativo', lastInspection: '08:00 AM' },
              { id: 'EQ-006', name: 'Bastón Tonfa', type: 'weapon', model: 'Polímero 24"', serial: 'B-223', status: 'Dañado', lastInspection: '08:00 AM', notes: 'Empuñadura rota' },
              { id: 'EQ-007', name: 'Libro de Minuta', type: 'doc', model: 'Cuaderno Actas 100h', serial: 'LIB-2024-10', status: 'Operativo', lastInspection: '08:00 AM' },
              { id: 'EQ-008', name: 'Armamento Letal (Ronda)', type: 'weapon', model: 'Revolver Llama .38', serial: 'R-990011', status: 'Operativo', lastInspection: '08:00 AM' },
            ],
            workstations: [
                 { id: 'WS-01', name: 'Puesto Principal - Zona Sur', location: 'Entrada Vehicular' }
            ],
            chatMessages: [
                {
                    id: '1',
                    role: 'model',
                    text: 'Sistema ZONA SUR en línea. Soy tu asistente de operaciones de seguridad. ¿En qué puedo ayudarte hoy?',
                    timestamp: new Date()
                }
            ],
            aiClient: null
        };

        // Initialize AI
        if (window.process && window.process.env && window.process.env.API_KEY) {
            state.aiClient = new GoogleGenAI({ apiKey: window.process.env.API_KEY });
        }

        // --- COMPONENTS RENDERERS ---

        // 1. LOGO COMPONENT
        // Intenta cargar /logo.png, si falla muestra el SVG automáticamente.
        function getLogoHTML(className = "w-10 h-10", classNameText = "text-xl", showText = false) {
            // El SVG de respaldo está oculto por defecto y se muestra si la imagen falla
            const svgFallback = `
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="${className} filter drop-shadow-lg logo-fallback hidden" aria-label="Oszford Logo">
                  <defs>
                    <linearGradient id="shieldGradient" x1="50" y1="0" x2="50" y2="100" gradientUnits="userSpaceOnUse">
                      <stop stopColor="#2563EB" />
                      <stop offset="1" stopColor="#1E40AF" />
                    </linearGradient>
                    <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                      <feGaussianBlur stdDeviation="5" result="coloredBlur" />
                      <feMerge>
                        <feMergeNode in="coloredBlur" />
                        <feMergeNode in="SourceGraphic" />
                      </feMerge>
                    </filter>
                  </defs>
                  <path d="M50 5L92 28V55C92 78 50 95 50 95C50 95 8 78 8 55V28L50 5Z" fill="url(#shieldGradient)" stroke="#1E293B" stroke-width="2" filter="url(#glow)" />
                  <path d="M50 12V22" stroke="white" stroke-width="2" stroke-linecap="round" stroke-opacity="0.8" />
                  <path d="M50 88V78" stroke="white" stroke-width="2" stroke-linecap="round" stroke-opacity="0.8" />
                  <path d="M18 50H28" stroke="white" stroke-width="2" stroke-linecap="round" stroke-opacity="0.8" />
                  <path d="M72 50H82" stroke="white" stroke-width="2" stroke-linecap="round" stroke-opacity="0.8" />
                  <circle cx="50" cy="50" r="16" stroke="white" stroke-width="3" class="animate-pulse" stroke-opacity="0.9" />
                  <circle cx="50" cy="50" r="8" fill="white" />
                  <path d="M50 20A30 30 0 0 1 80 50" stroke="#93C5FD" stroke-width="2" stroke-linecap="round" class="opacity-60" />
                  <path d="M20 50A30 30 0 0 1 50 80" stroke="#93C5FD" stroke-width="2" stroke-linecap="round" class="opacity-60" />
                </svg>
            `;

            return `
            <div class="flex items-center gap-3 select-none logo-container">
                <img 
                    src="/logo.png" 
                    alt="Oszford Logo" 
                    class="${className} object-contain drop-shadow-md logo-image"
                    onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');"
                />
                ${svgFallback}
                
                ${showText ? `
                <div class="flex flex-col">
                  <span class="font-black tracking-widest font-mono text-white leading-none ${classNameText}">
                    OSZFORD
                  </span>
                  <span class="text-[10px] text-blue-400 font-medium tracking-[0.3em] uppercase leading-none mt-1.5 ml-0.5">
                    Security Systems
                  </span>
                </div>` : ''}
            </div>
            `;
        }

        // 2. LOGIN VIEW
        function renderLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
            <div class="min-h-screen bg-[#0B1120] flex items-center justify-center p-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0 opacity-10 pointer-events-none">
                    <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-600/20 rounded-full blur-[120px]"></div>
                    <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-indigo-600/20 rounded-full blur-[120px]"></div>
                </div>
                <div class="bg-slate-900/90 backdrop-blur-2xl rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-700/50 z-10">
                    <div class="p-10 pb-6 text-center border-b border-slate-700/50 bg-gradient-to-b from-slate-800/50 to-transparent flex flex-col items-center">
                        <div class="mb-6 transform hover:scale-105 transition-transform duration-500 hover:drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">
                            ${getLogoHTML("w-24 h-24")}
                        </div>
                        <h1 class="text-3xl font-black text-white tracking-[0.15em] font-mono">OSZFORD</h1>
                        <div class="h-0.5 w-16 bg-blue-600 my-3 rounded-full"></div>
                        <p class="text-slate-400 text-xs uppercase tracking-[0.3em]">Advanced Security</p>
                    </div>
                    
                    <form id="loginForm" class="p-8 space-y-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block ml-1">ID Operador</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-500 transition-colors">
                                    <i data-lucide="user" class="w-5 h-5"></i>
                                </div>
                                <input type="text" id="username" class="w-full pl-10 pr-4 py-3 bg-slate-950/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all placeholder:text-slate-600 font-mono text-sm" placeholder="USER-ID" required />
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block ml-1">Contraseña</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-500 transition-colors">
                                    <i data-lucide="lock" class="w-5 h-5"></i>
                                </div>
                                <input type="password" id="password" class="w-full pl-10 pr-4 py-3 bg-slate-950/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all placeholder:text-slate-600 font-mono text-sm" placeholder="••••••••" required />
                            </div>
                        </div>
                        <div id="loginError" class="hidden p-3 bg-red-500/10 text-red-400 text-xs rounded-lg text-center font-medium border border-red-500/20"></div>
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 rounded-lg shadow-lg shadow-blue-900/20 transition-all transform hover:translate-y-[-1px] active:translate-y-[0px] uppercase tracking-wide text-sm">Iniciar Sesión</button>
                    </form>
                    <div class="text-center pb-6 border-t border-slate-800 pt-4">
                        <p class="text-[10px] text-slate-600 font-mono">SYSTEM V.4.2.0 • AUTHORIZED PERSONNEL ONLY</p>
                    </div>
                </div>
            </div>
            `;
            lucide.createIcons();

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                const errDiv = document.getElementById('loginError');

                if (u === 'Diego Valencia' && p === '12345') {
                    state.currentUser = { name: 'Diego Valencia', role: 'admin', avatar: 'DV' };
                    state.isAuthenticated = true;
                    renderMainLayout();
                } else if (u === 'supervisor' && p === 'sup123') {
                    state.currentUser = { name: 'Oficial R. Sanchez', role: 'supervisor', avatar: 'RS' };
                    state.isAuthenticated = true;
                    renderMainLayout();
                } else {
                    errDiv.textContent = 'ID o Clave incorrectos';
                    errDiv.classList.remove('hidden');
                }
            });
        }

        // 3. MAIN LAYOUT
        function renderMainLayout() {
            const app = document.getElementById('app');
            app.innerHTML = `
            <div class="flex h-screen bg-slate-50 overflow-hidden font-sans">
                <!-- Sidebar -->
                <aside id="sidebar" class="${state.isSidebarOpen ? 'w-64' : 'w-20'} bg-[#0B1120] transition-all duration-300 flex flex-col border-r border-slate-800 z-20 shadow-2xl">
                    <div class="h-24 flex items-center justify-center border-b border-slate-800/50 bg-[#0B1120]">
                        <div id="logo-container" class="flex items-center animate-in fade-in duration-300 px-4 transition-all">
                            ${state.isSidebarOpen ? getLogoHTML("w-10 h-10", "text-lg", true) : getLogoHTML("w-10 h-10", "", false)}
                        </div>
                    </div>
                    <nav class="flex-1 py-6 px-3 space-y-2 overflow-y-auto custom-scrollbar">
                        ${renderNavItem('personnel', 'users', 'Gestión Zona Sur')}
                        ${renderNavItem('dashboard', 'layout-dashboard', 'Puesto de Trabajo')}
                        ${renderNavItem('incidents', 'alert-octagon', 'Incidentes')}
                        ${renderNavItem('map', 'map', 'Plano General')}
                        <div class="pt-4 mt-4 border-t border-slate-800/50">
                            ${renderNavItem('ai', 'cpu', 'OSZFORD AI')}
                        </div>
                    </nav>
                    <div class="p-4 border-t border-slate-800/50 bg-[#0B1120]">
                        <button id="logoutBtn" class="flex items-center space-x-3 text-slate-400 hover:text-red-400 transition-colors w-full p-2 rounded-lg hover:bg-white/5">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                            ${state.isSidebarOpen ? '<span class="font-medium">Desconectar</span>' : ''}
                        </button>
                    </div>
                </aside>

                <!-- Content -->
                <main class="flex-1 flex flex-col min-w-0 bg-[#f8fafc]">
                    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-10">
                        <button id="toggleSidebar" class="text-slate-500 hover:text-blue-600 transition-colors">
                            <i data-lucide="menu" class="w-5 h-5"></i>
                        </button>
                        <div class="flex items-center space-x-6">
                             <div class="hidden md:flex items-center bg-slate-50 rounded-lg px-4 py-2 border border-slate-200 focus-within:border-blue-300 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 mr-2"></i>
                                <input type="text" placeholder="Búsqueda global..." class="bg-transparent border-none outline-none text-sm text-slate-700 w-48 placeholder:text-slate-400"/>
                             </div>
                             <button class="relative p-2 text-slate-500 hover:bg-slate-100 rounded-full transition-colors">
                                <i data-lucide="bell" class="w-5 h-5"></i>
                                <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                             </button>
                             <div class="flex items-center space-x-3 pl-4 border-l border-slate-200">
                                <div class="text-right hidden md:block">
                                  <p class="text-sm font-bold text-slate-900">${state.currentUser.name}</p>
                                  <p class="text-[10px] text-blue-600 uppercase tracking-wider font-bold">${state.currentUser.role === 'admin' ? 'Comandante' : 'Supervisor'}</p>
                                </div>
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold border-2 border-white shadow-md ${state.currentUser.role === 'admin' ? 'bg-gradient-to-br from-blue-700 to-indigo-800' : 'bg-slate-500'}">
                                  ${state.currentUser.avatar}
                                </div>
                             </div>
                        </div>
                    </header>
                    <div id="contentArea" class="flex-1 overflow-auto p-6 relative"></div>
                </main>
            </div>
            `;
            
            lucide.createIcons();
            attachLayoutListeners();
            renderCurrentView();
        }

        function renderNavItem(viewId, iconName, label) {
            const active = state.currentView === viewId;
            const cls = active ? 'bg-blue-900/30 text-blue-400 border-l-4 border-blue-500' : 'text-slate-400 hover:bg-slate-800/50 hover:text-slate-200';
            return `
            <button onclick="window.changeView('${viewId}')" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-200 mb-1 font-medium group ${cls}">
                <i data-lucide="${iconName}" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                <span class="${state.isSidebarOpen ? "opacity-100 max-w-full" : "opacity-0 max-w-0 hidden"} overflow-hidden whitespace-nowrap transition-all duration-300">
                    ${label}
                </span>
            </button>`;
        }

        window.changeView = (view) => {
            state.currentView = view;
            renderMainLayout(); // Re-render to update nav active state
        };

        function attachLayoutListeners() {
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                state.isSidebarOpen = !state.isSidebarOpen;
                renderMainLayout();
            });
            document.getElementById('logoutBtn').addEventListener('click', () => {
                state.isAuthenticated = false;
                state.currentUser = null;
                renderLogin();
            });
        }

        function renderCurrentView() {
            const container = document.getElementById('contentArea');
            container.innerHTML = '';
            
            switch(state.currentView) {
                case 'dashboard': renderDashboard(container); break;
                case 'incidents': renderIncidentManager(container); break;
                case 'personnel': renderPersonnelManager(container); break;
                case 'map': renderZoneMap(container); break;
                case 'ai': renderAIAssistant(container); break;
            }
            lucide.createIcons();
        }

        // 4. DASHBOARD VIEW
        function renderDashboard(container) {
            const currentStation = state.workstations[0];
            
            let equipHTML = state.equipment.map(item => {
                let colorClass = '';
                if(item.status === 'Operativo') colorClass = 'bg-emerald-100 text-emerald-700 border-emerald-200';
                else if(item.status === 'Dañado') colorClass = 'bg-red-100 text-red-700 border-red-200';
                else colorClass = 'bg-amber-100 text-amber-700 border-amber-200';

                let iconName = 'shield';
                if(item.type === 'weapon') iconName = 'crosshair';
                if(item.type === 'comms') iconName = 'radio';
                if(item.type === 'light') iconName = 'flashlight';
                if(item.type === 'protection') iconName = 'umbrella';
                if(item.type === 'doc') iconName = 'clipboard-list';

                return `
                <div class="flex items-center p-3 rounded-lg border border-slate-100 hover:border-blue-200 hover:shadow-md transition-all bg-white">
                    <div class="p-3 rounded-lg ${item.type === 'weapon' ? 'bg-slate-800 text-white' : item.type === 'comms' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}">
                        <i data-lucide="${iconName}" class="w-5 h-5"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="flex justify-between items-start">
                             <div>
                                <h4 class="font-bold text-slate-900 text-sm">${item.name}</h4>
                                <p class="text-xs text-slate-500 font-mono">${item.model} • S/N: ${item.serial}</p>
                             </div>
                             <span class="text-[10px] px-2 py-0.5 rounded-full border font-bold uppercase ${colorClass}">${item.status}</span>
                        </div>
                         <div class="flex items-center gap-4 mt-2">
                          ${(item.type === 'comms' || item.type === 'light') && item.batteryLevel !== undefined ? `
                            <div class="flex items-center gap-1 text-xs font-mono text-slate-600">
                               <i data-lucide="battery" class="w-3 h-3 ${item.batteryLevel < 20 ? 'text-red-500' : 'text-green-500'}"></i>
                               ${item.batteryLevel}%
                            </div>` : ''}
                          <span class="text-[10px] text-slate-400">Insp: ${item.lastInspection}</span>
                          ${item.notes ? `<span class="text-[10px] text-amber-600 bg-amber-50 px-1 rounded truncate max-w-[150px]">${item.notes}</span>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = `
            <div class="h-full flex flex-col space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start pb-4 border-b border-slate-200">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                           <i data-lucide="layout" class="text-blue-600 w-7 h-7"></i> Puesto de Trabajo
                        </h2>
                        <p class="text-slate-500 text-sm mt-2 flex items-center gap-2">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                            Ubicación: <span class="font-mono text-slate-700">${currentStation.location}</span>
                        </p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                               <i data-lucide="clipboard-list" class="w-4 h-4 text-blue-600"></i> Inventario: ${currentStation.name}
                            </h3>
                            <span class="text-xs font-medium text-slate-500 bg-white px-2 py-1 rounded border border-slate-200">${state.equipment.length} Elementos</span>
                        </div>
                        <div class="flex-1 overflow-auto p-4 grid gap-3">
                            ${equipHTML}
                        </div>
                    </div>
                    <!-- Right stats -->
                    <div class="space-y-6 flex flex-col">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex-1">
                            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                <i data-lucide="crosshair" class="w-5 h-5 text-slate-800"></i> Control de Armamento
                            </h3>
                            <div class="space-y-3 mb-6">
                                ${state.equipment.filter(e => e.type === 'weapon').map(w => `
                                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex flex-col gap-1">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-slate-800 text-sm">${w.name}</span>
                                            <span class="text-[10px] px-2 py-0.5 rounded-full border font-bold uppercase ${w.status === 'Operativo' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">${w.status}</span>
                                        </div>
                                        <div class="flex justify-between text-xs text-slate-500 font-mono">
                                            <span>${w.model}</span>
                                            <span>S/N: ${w.serial}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-slate-100">
                                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Resumen: ${currentStation.name}</h4>
                                <div class="space-y-2">
                                   <div class="flex justify-between text-sm">
                                      <span class="text-slate-600">Total Elementos</span>
                                      <span class="font-bold text-slate-900">${state.equipment.length}</span>
                                   </div>
                                   <div class="flex justify-between text-sm">
                                      <span class="text-slate-600">Armamento</span>
                                      <span class="font-bold text-slate-900">${state.equipment.filter(e => e.type === 'weapon').length}</span>
                                   </div>
                                   <div class="flex justify-between text-sm">
                                      <span class="text-slate-600">Con Novedad</span>
                                      <span class="font-bold text-red-600">${state.equipment.filter(e => e.status !== 'Operativo').length}</span>
                                   </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // 5. INCIDENTS VIEW
        function renderIncidentManager(container) {
            const incidentsHTML = state.incidents.map(inc => `
                <tr class="hover:bg-slate-50 transition-colors">
                  <td class="p-4 text-sm font-mono text-slate-500">#${inc.id.slice(-4)}</td>
                  <td class="p-4">
                    <p class="text-sm font-medium text-slate-900">${inc.title}</p>
                    <p class="text-xs text-slate-500 truncate max-w-xs">${inc.description}</p>
                  </td>
                  <td class="p-4 text-sm text-slate-600">${inc.location}</td>
                  <td class="p-4"><span class="text-xs px-2 py-1 rounded-full font-medium ${inc.severity === 'Alta' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">${inc.severity}</span></td>
                  <td class="p-4"><span class="text-xs px-2 py-1 rounded-full font-medium bg-slate-100 border border-slate-200">${inc.status}</span></td>
                  <td class="p-4 text-sm text-slate-500">${inc.timestamp}</td>
                </tr>
            `).join('');

            container.innerHTML = `
            <div class="h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-900">Registro de Incidentes</h2>
                    <button id="newIncidentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Nuevo Reporte
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden flex-1 flex flex-col">
                     <div class="p-4 border-b border-slate-100 flex gap-4">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                            <input type="text" placeholder="Buscar incidentes..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm"/>
                        </div>
                     </div>
                    <div class="overflow-auto flex-1">
                         <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 sticky top-0 z-10">
                                <tr>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">ID</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Incidente</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Ubicación</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Severidad</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Estado</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Hora</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">${incidentsHTML}</tbody>
                         </table>
                    </div>
                </div>
            </div>`;

            // Simple "Add Incident" Logic (Just a prompt for simplicity in this version)
            document.getElementById('newIncidentBtn').addEventListener('click', () => {
                const title = prompt("Título del Incidente:");
                if(title) {
                    const desc = prompt("Descripción:");
                    state.incidents.unshift({
                        id: 'INC-' + Date.now(),
                        title: title,
                        description: desc || '',
                        location: 'N/A',
                        severity: 'Media',
                        status: 'Abierto',
                        timestamp: new Date().toLocaleTimeString(),
                        reportedBy: state.currentUser.name,
                        coordinates: { x: 50, y: 50 }
                    });
                    renderIncidentManager(container);
                }
            });
        }

        // 6. PERSONNEL VIEW
        function renderPersonnelManager(container) {
            const guardsHTML = state.guards.map(g => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 border border-slate-200">
                                <i data-lucide="user" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-900">${g.name}</p>
                                <p class="text-xs text-slate-400">${g.role}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-sm font-mono text-slate-600"><i data-lucide="id-card" class="w-3 h-3 inline mr-1"></i>${g.cedula}</td>
                    <td class="p-4 text-sm text-slate-700 flex items-center gap-2"><i data-lucide="map-pin" class="w-3 h-3 text-blue-500"></i>${g.location}</td>
                    <td class="p-4">
                        <span class="px-2.5 py-1 rounded-full text-xs font-medium border ${g.status === 'Active' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-slate-100 text-slate-600'}">
                            ${g.status}
                        </span>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
            <div class="h-full flex flex-col space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">Personal Zona Sur</h2>
                        <p class="text-slate-500 text-sm">Gestión Operativa de Vigilantes</p>
                    </div>
                </div>
                 <!-- Search -->
                <div class="flex items-center space-x-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex-1 relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                        <input type="text" placeholder="Buscar por nombre, cédula o puesto..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm"/>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-10">
                                <tr>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Vigilante</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">ID</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Puesto</th>
                                    <th class="p-4 text-xs font-semibold text-slate-500 uppercase">Estado</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${guardsHTML}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }

        // 7. ZONE MAP
        function renderZoneMap(container) {
             // Create SVG string for the map
             const mapSVG = `
             <svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice" class="opacity-100">
                  <defs>
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1e293b" stroke-width="0.5"/>
                      <circle cx="0" cy="0" r="1" fill="#334155" />
                    </pattern>
                    <filter id="glowMap">
                      <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                      <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                      </feMerge>
                    </filter>
                  </defs>
                  <rect width="100%" height="100%" fill="url(#grid)" />
                  <g class="building" stroke="#475569" stroke-width="2">
                     <path d="M 200 150 L 600 150 L 600 450 L 200 450 Z" fill="#1e293b" fill-opacity="0.8" />
                     <path d="M 350 150 L 350 450" stroke="#334155" /> 
                     <path d="M 200 300 L 600 300" stroke="#334155" />
                     <rect x="220" y="170" width="100" height="80" fill="#0f172a" stroke="#3b82f6" stroke-width="1" />
                     <text x="270" y="215" fill="#60a5fa" font-size="10" text-anchor="middle" font-family="monospace" letter-spacing="1">SECURE OPS</text>
                     <rect x="220" y="350" width="110" height="80" fill="#0f172a" stroke="#334155" />
                     <text x="275" y="395" fill="#64748b" font-size="10" text-anchor="middle">ARMORY</text>
                  </g>
                  <g class="parking" fill="none" stroke="#334155" stroke-width="1" stroke-dasharray="4,4">
                     <path d="M 50 50 L 170 50 L 170 450 L 50 450 Z" />
                  </g>
                  <rect x="380" y="445" width="40" height="10" fill="#22c55e" filter="url(#glowMap)" opacity="0.6" />
             </svg>`;

             let markers = '';
             // Guards
             state.guards.forEach(g => {
                 markers += `
                 <div class="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer z-20 group" style="left: ${g.coordinates.x}%; top: ${g.coordinates.y}%">
                    <div class="relative flex items-center justify-center w-9 h-9 rounded-full border-2 border-blue-200 bg-blue-600 shadow-lg">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                        <span class="absolute -top-1 -right-1 w-3 h-3 rounded-full border-2 border-[#0b1121] ${g.status === 'Active' ? 'bg-green-500' : 'bg-red-500'}"></span>
                    </div>
                    <div class="absolute top-10 left-1/2 transform -translate-x-1/2 bg-slate-900/90 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap">
                        ${g.name}
                    </div>
                 </div>`;
             });

             container.innerHTML = `
             <div class="h-full flex flex-col bg-[#0f172a] rounded-xl overflow-hidden relative shadow-2xl border border-slate-800">
                <div class="absolute top-4 left-4 z-20 bg-slate-900/90 border border-slate-700 p-3 rounded-lg text-white shadow-xl">
                   <h3 class="font-bold text-sm mb-1 tracking-wider font-mono text-blue-400">OSZFORD TACTICAL</h3>
                   <div class="text-xs text-slate-400">
                      <span class="block">● Unidades: ${state.guards.length}</span>
                   </div>
                </div>
                <div class="flex-1 overflow-hidden relative bg-[#0b1121] cursor-crosshair">
                   <div class="absolute inset-0 pointer-events-none opacity-20">
                       <div class="absolute top-1/2 left-1/2 w-full h-full -translate-x-1/2 -translate-y-1/2 origin-center radar-sweep bg-gradient-to-r from-transparent via-blue-900/10 to-transparent"></div>
                   </div>
                   <div class="w-full h-full relative">
                        ${mapSVG}
                        ${markers}
                   </div>
                </div>
             </div>`;
        }

        // 8. AI ASSISTANT VIEW
        function renderAIAssistant(container) {
            const msgsHTML = state.chatMessages.map(msg => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="flex max-w-[80%] ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'} items-start gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-indigo-600 text-white'}">
                             <i data-lucide="${msg.role === 'user' ? 'user' : 'bot'}" class="w-4 h-4"></i>
                        </div>
                        <div class="p-4 rounded-2xl shadow-sm ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-slate-800 border border-slate-100 rounded-tl-none'}">
                            <p class="text-sm leading-relaxed whitespace-pre-wrap">${msg.text}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
            <div class="h-full max-w-4xl mx-auto flex flex-col bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center space-x-3">
                    <div class="p-2 bg-indigo-600 rounded-lg text-white"><i data-lucide="bot" class="w-5 h-5"></i></div>
                    <div>
                        <h3 class="font-bold text-slate-900">Operador Virtual</h3>
                        <p class="text-xs text-slate-500">Conectado a Red Neuronal</p>
                    </div>
                </div>
                <div id="chatContainer" class="flex-1 overflow-y-auto p-4 bg-slate-50/50">
                    ${msgsHTML}
                </div>
                <div class="p-4 border-t border-slate-100 bg-white">
                    <div class="relative">
                        <textarea id="aiInput" class="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500/20 text-sm resize-none h-14" placeholder="Consultar protocolos..."></textarea>
                        <button id="sendAiBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>`;

            // Auto scroll
            const chatC = document.getElementById('chatContainer');
            if(chatC) chatC.scrollTop = chatC.scrollHeight;

            // Handlers
            const handleSend = async () => {
                const input = document.getElementById('aiInput');
                const text = input.value.trim();
                if(!text) return;

                // User msg
                state.chatMessages.push({ id: Date.now().toString(), role: 'user', text, timestamp: new Date() });
                renderAIAssistant(container);

                let responseText = "IA no configurada o error de conexión.";
                if(state.aiClient) {
                     try {
                        const model = state.aiClient.models;
                        // Simplest invoke
                        const result = await model.generateContent({
                            model: 'gemini-2.0-flash', 
                            contents: text,
                            config: {
                                systemInstruction: "Eres un experto en seguridad física para 'ZONA SUR'. Responde conciso y profesional."
                            }
                        });
                        responseText = result.text || "Sin respuesta.";
                     } catch(e) {
                        console.error(e);
                        responseText = "Error al conectar con Gemini. Verifica tu API Key.";
                     }
                }

                state.chatMessages.push({ id: (Date.now()+1).toString(), role: 'model', text: responseText, timestamp: new Date() });
                renderAIAssistant(container);
            };

            document.getElementById('sendAiBtn').addEventListener('click', handleSend);
            document.getElementById('aiInput').addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
        }


        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderLogin();
        });

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
